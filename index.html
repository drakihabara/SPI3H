<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>é«˜æ ¡ç”Ÿç”¨SPIå¯¾ç­–</title>
<style>
  /* æ‹¡å¤§é˜²æ­¢ã¨åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
  html, body {
    touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹åŒ– */
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0; padding: 0.5rem; background: #f9f9f9; color: #333; font-size: 18px; line-height: 1.6;
  }
  h1 { text-align: center; font-size: 1.6rem; margin: 1rem 0 1.5rem; color: #2c3e50; }
  .container { width: 100%; max-width: 500px; margin: 0 auto; box-sizing: border-box; }
  
  /* ãƒœã‚¿ãƒ³ã®æ‹¡å¤§é˜²æ­¢ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
  .tag-btn, #options button {
    touch-action: manipulation;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .tag-btn {
    display: block; width: 100%; padding: 1.5rem 1rem; margin: 1rem 0;
    border: 1px solid #dcdde1; border-radius: 12px; font-size: 1.2rem; font-weight: bold;
    background: #fff; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    color: #2f3640; text-decoration: none; box-sizing: border-box;
  }
  .tag-btn:active { background: #f5f6fa; transform: scale(0.98); }
  .btn-verbal { border-left: 10px solid #3498db; }
  .btn-nonverbal { border-left: 10px solid #e74c3c; }
  
  #question { margin: 1rem 0.5rem 2.5rem; line-height: 1.6; white-space: pre-wrap; }

  /* â–¼â–¼â–¼ ä»Šå›è¿½åŠ ï¼šç”»åƒã®æ¨ªå¹…åˆ¶é™ã¨ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
  .q-img {
    max-width: 100%;      /* è¦ªè¦ç´ ã®å¹…ã‚’è¶…ãˆãªã„ã‚ˆã†ã«åˆ¶é™ */
    height: auto;         /* ç¸¦æ¨ªæ¯”ã‚’ç¶­æŒ */
    display: block;       /* ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã—ã¦ä¸­å¤®æƒãˆ */
    margin: 1.5rem auto;  /* ä¸Šä¸‹ã®ä½™ç™½ã¨å·¦å³ã®ä¸­å¤®æƒãˆ */
    border-radius: 8px;   /* è§’ã‚’å°‘ã—ä¸¸ã */
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); /* è»½ã„å½±ã‚’è¿½åŠ  */
  }
  /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

  /* ç…§åˆå•é¡Œç”¨ */
  .matching-container { display: flex; justify-content: center; gap: 2rem; font-size: 1.6rem; font-weight: bold; font-family: monospace; margin: 2rem 0; }
  
  /* è¨€èªåˆ†é‡å¼·èª¿ç”¨ */
  .q-prompt { display: block; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #000; text-align: center; }
  .q-sub { display: block; font-size: 1.2rem; margin-bottom: 0.3rem; padding-left: 1rem; }

  /* å…±é€šãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
  .sub-table {
    width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; table-layout: fixed;
    background: #fff; border: 1px solid #000; font-family: "MS Mincho", "Hiragino Mincho ProN", serif;
    font-size: 0.95rem;
  }
  .sub-table th, .sub-table td { border: 1px solid #000; padding: 8px 2px; text-align: center; line-height: 1.3; }
  .sub-table .no-border { border: none; }
  .legend-cell { font-size: 0.75rem; text-align: left; padding: 4px; border: none !important; }
  .legend-box { border: 1px solid #000; display: inline-block; padding: 3px; margin-bottom: 3px; }

  #options { list-style: none; padding: 0; margin: 0; }
  #options li { margin-bottom: 0.8rem; }
  #options button {
    width: 100%; padding: 1.1rem; font-size: 1.1rem; border: 1px solid #ccc;
    border-radius: 12px; background: #fff; text-align: left; line-height: 1.4;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  #options button:disabled { opacity: 1.0; color: #333; }
  #progress { text-align: center; margin-top: 1.5rem; color: #888; font-size: 0.9rem; }
  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7); display: none;
    align-items: center; justify-content: center; z-index: 100;
  }
  #modal { background: #fff; padding: 1.5rem; border-radius: 15px; width: 92%; max-width: 400px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
  #modal-message { font-size: 1.4rem; font-weight: bold; text-align: center; margin-bottom: 0.8rem; }
  #modal-explanation { font-size: 1rem; color: #444; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
  #modalNextBtn {
    display: block; width: 100%; padding: 1rem; margin-top: 1.5rem;
    border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold;
    background: #3498db; color: #fff; cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">
  <h1 id="mainTitle">é«˜æ ¡ç”Ÿç”¨SPIå¯¾ç­–</h1>
  <div id="category-select">
    <button class="tag-btn btn-verbal" onclick="startQuiz('verbal')">è¨€èªåˆ†é‡</button>
    <button class="tag-btn btn-nonverbal" onclick="startQuiz('nonverbal')">éè¨€èªåˆ†é‡</button>
  </div>
  <div id="quiz" style="display:none;">
    <div id="question"></div>
    <ul id="options"></ul>
    <div id="progress"></div>
  </div>
  <div id="result" style="display:none; text-align:center;">
    <div id="result-content"></div>
    <button class="tag-btn" style="background:#d4edda; border-color:#28a745;" onclick="restartWithNewQuestions()">ç¶šã‘ã‚‹</button>
    <button class="tag-btn" style="background:#f1f2f6; border-color:#dcdde1;" onclick="location.reload()">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
  </div>
</div>
<div id="overlay">
  <div id="modal">
    <div id="modal-message"></div>
    <div id="modal-explanation"></div>
    <button id="modalNextBtn">æ¬¡ã¸ â–¶</button>
  </div>
</div>
<script>
  let allQuestions = []; 
  let questions = [];    
  let current = 0, score = 0, currentFileName = '';
  async function startQuiz(tag) {
    document.getElementById('category-select').style.display = 'none';
    document.getElementById('mainTitle').style.display = 'none'; 
    currentFileName = `${tag}.csv`;
    try {
      allQuestions = await loadCSV(currentFileName);
    } catch(err) {
      alert("èª­ã¿è¾¼ã¿å¤±æ•—");
      location.reload();
      return;
    }
    restartWithNewQuestions();
  }
  function getClearedIds() {
    const data = localStorage.getItem('cleared_' + currentFileName);
    return data ? JSON.parse(data) : [];
  }
  function saveClearedId(id) {
    let cleared = getClearedIds();
    if (!cleared.includes(id)) {
      cleared.push(id);
      localStorage.setItem('cleared_' + currentFileName, JSON.stringify(cleared));
    }
  }
  function restartWithNewQuestions() {
    document.getElementById('result').style.display = 'none';
    const clearedIds = getClearedIds();
    const unsolved = allQuestions.filter(q => !clearedIds.includes(q.id));
    const solved = allQuestions.filter(q => clearedIds.includes(q.id));
    let selection = shuffle([...unsolved]);
    if (selection.length < 10) {
      const needed = 10 - selection.length;
      selection = selection.concat(shuffle([...solved]).slice(0, needed));
    } else {
      selection = selection.slice(0, 10);
    }
    questions = selection;
    current = 0; score = 0;
    document.getElementById('quiz').style.display = 'block';
    showQuestion();
  }
  async function loadCSV(file) {
    const response = await fetch(file);
    const text = await response.text();
    return text.trim().split(/\r?\n/).slice(1).map(line => {
      const c = line.split('\t').map(s => s.replace(/^"|"$/g, '').replace(/""/g, '"'));
      if (c.length < 12) return null;
      return { 
        id: c[0], 
        q: c[1].replace(/\\n/g, '\n'), 
        img: c[2], 
        options: c.slice(3, 10).filter(o => o !== ""), 
        answer: parseInt(c[10]) - 1, 
        explanation: c[11].replace(/\\n/g, '\n') 
      };
    }).filter(q => q !== null);
  }
  function shuffle(a) {
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }
  function renderGenericTable(tableStr) {
    const rows = tableStr.replace('[TABLE]', '').split(';');
    let tableHtml = '<table class="sub-table">';
    rows.forEach((row, i) => {
      tableHtml += '<tr>';
      const cells = row.split('|');
      cells.forEach(cell => {
        const content = cell.replace(/\\n/g, '<br>');
        tableHtml += (i === 0) ? `<th>${content}</th>` : `<td>${content}</td>`;
      });
      tableHtml += '</tr>';
    });
    tableHtml += '</table>';
    return tableHtml;
  }
  function showQuestion() {
    const q = questions[current];
    let qHtml = '';
    const partsSub = q.q.split(' / ');
    
    if (partsSub.length > 1 && partsSub[0].includes('=')) {
      let subTable = '<table class="sub-table" style="font-family:sans-serif; margin-bottom:1rem;"><tr>';
      const mappings = partsSub[0].trim().split(/\s+/);
      mappings.forEach(m => {
        const pair = m.split('=');
        if (pair[0]) subTable += `<th style="background:#eee;">${pair[0]}</th>`;
      });
      subTable += '</tr><tr>';
      mappings.forEach(m => {
        const pair = m.split('=');
        if (pair[1]) subTable += `<td>${pair[1]}</td>`;
      });
      subTable += '</tr></table>';
      qHtml = subTable + `<div style="text-align:center; font-size:1.4rem; margin:1rem 0;">${partsSub[1].replace(/\n/g, '<br>')}</div>`;
    } 
    else if (q.id.match(/^V0(0[1-9]|1[0-6])$/)) {
      const lines = q.q.split('\n');
      qHtml = `<div class="matching-container"><span>${lines[0]}</span><span>${lines[1]}</span></div>`;
    } 
    else if (q.id.startsWith('V') && q.q.includes('\n')) {
      const lines = q.q.split('\n');
      qHtml = `<span class="q-prompt">${lines[0]}</span>`;
      for(let i=1; i<lines.length; i++) {
        qHtml += `<span class="q-sub">${lines[i]}</span>`;
      }
    } 
    else {
      qHtml = `<div>${q.q.replace(/\n/g, '<br>')}</div>`;
    }

    if (q.img && q.img.startsWith('[FARE]')) {
      const data = q.img.replace('[FARE]', '').split(';');
      const stations = data[0].split('|');
      let fareTable = '<table class="sub-table">';
      fareTable += `<tr><th>é§…å</th><th>${stations[0]}</th><td colspan="5" class="legend-cell"><div class="legend-box">ä¸Šæ®µ æ™®é€šé‹è³ƒ<br>ä¸‹æ®µ æ™®é€šé‹è³ƒ+ç‰¹æ€¥æ–™é‡‘</div><br>â€»å®Ÿéš›ã¨ã¯ç•°ãªã‚‹</td></tr>`;
      for (let i = 1; i < stations.length; i++) {
        fareTable += `<tr><th>${stations[i]}</th>`;
        const prices = data[i].split('|');
        for (let j = 0; j < i; j++) { fareTable += `<td>${prices[j].replace(/\\n/g, '<br>')}</td>`; }
        fareTable += `<th>${stations[i]}</th>`;
        for (let j = i + 1; j < stations.length; j++) { fareTable += '<td class="no-border"></td>'; }
        fareTable += '</tr>';
      }
      fareTable += '</table>';
      qHtml += fareTable;
    } else if (q.img && q.img.startsWith('[TABLE]')) {
      qHtml += renderGenericTable(q.img);
    } else if (q.img && q.img.trim() !== "") {
      qHtml += `<img src="images/${q.img}" class="q-img">`;
    }
    
    document.getElementById('question').innerHTML = qHtml;
    const ul = document.getElementById('options');
    ul.innerHTML = '';
    q.options.forEach((opt, i) => {
      const li = document.createElement('li');
      li.innerHTML = `<button><span>${opt}</span></button>`;
      li.firstChild.onclick = () => selectAnswer(i);
      ul.appendChild(li);
    });
    document.getElementById('progress').textContent = `${current + 1} / ${questions.length}`;
  }
  function selectAnswer(idx) {
    const q = questions[current];
    const btns = document.getElementById('options').querySelectorAll('button');
    btns.forEach((btn, i) => {
      btn.disabled = true;
      if (i === q.answer) btn.style.background = '#d4edda';
      else if (i === idx) btn.style.background = '#f8d7da';
    });
    const isCorrect = (idx === q.answer);
    if (isCorrect) { score++; saveClearedId(q.id); }
    document.getElementById('modal-message').innerHTML = isCorrect ? 'ğŸŸ¢ æ­£è§£' : 'âŒ ä¸æ­£è§£';
    let expText = q.explanation;
    if (expText.includes('[TABLE]')) {
      const tableMatch = expText.match(/\[TABLE\].+$/);
      if (tableMatch) {
        const tablePart = tableMatch[0];
        const textPart = expText.replace(tablePart, '');
        expText = textPart + '<br>' + renderGenericTable(tablePart);
      }
    }
    document.getElementById('modal-explanation').innerHTML = "æ­£è§£ï¼š<strong>" + q.options[q.answer] + "</strong><br><br><strong>è§£èª¬:</strong><br>" + expText.replace(/\n/g, '<br>');
    document.getElementById('overlay').style.display = 'flex';
  }
  document.getElementById('modalNextBtn').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    if (++current < questions.length) showQuestion();
    else showResults();
  };
  function showResults() {
    document.getElementById('quiz').style.display = 'none';
    const r = document.getElementById('result');
    document.getElementById('result-content').innerHTML = `<h2>çµæœ</h2><div style="font-size:2.5rem; font-weight:bold;">${score} / ${questions.length}</div>`;
    r.style.display = 'block';
  }
</script>
</body>
</html>
