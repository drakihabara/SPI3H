<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>È´òÊ†°ÁîüÁî®SPIÂØæÁ≠ñ</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0; padding: 0.5rem; background: #f9f9f9; color: #333; font-size: 18px; line-height: 1.6;
  }
  h1 { text-align: center; font-size: 1.6rem; margin: 1rem 0 1.5rem; color: #2c3e50; }
  .container { width: 100%; max-width: 500px; margin: 0 auto; box-sizing: border-box; }
  .tag-btn {
    display: block; width: 100%; padding: 1.5rem 1rem; margin: 1rem 0;
    border: 1px solid #dcdde1; border-radius: 12px; font-size: 1.2rem; font-weight: bold;
    background: #fff; text-align: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    color: #2f3640; text-decoration: none; box-sizing: border-box;
  }
  .tag-btn:active { background: #f5f6fa; transform: scale(0.98); }
  .btn-verbal { border-left: 10px solid #3498db; }
  .btn-nonverbal { border-left: 10px solid #e74c3c; }
  #question { margin: 1rem 0.5rem; font-size: 1.1rem; font-weight: bold; line-height: 1.5; white-space: pre-wrap; }
  .sub-table {
    width: 100%; border-collapse: collapse; margin-bottom: 1rem; table-layout: fixed;
    background: #fff; border: 2px solid #333; font-size: 0.8rem;
  }
  .sub-table th, .sub-table td {
    border: 1px solid #333; padding: 4px 1px; text-align: center; line-height: 1.2;
  }
  .sub-table th { background: #eee; font-weight: bold; }
  .q-img { width: 100%; max-width: 400px; display: block; margin: 10px auto; border: 1px solid #eee; border-radius: 8px; }
  #options { list-style: none; padding: 0; margin: 0; }
  #options li { margin-bottom: 0.5rem; }
  #options button {
    width: 100%; padding: 0.9rem; font-size: 1rem; border: 1px solid #ccc;
    border-radius: 10px; background: #fff; text-align: left; line-height: 1.4;
  }
  #options button:disabled { opacity: 1.0; color: #333; }
  #progress { text-align: center; margin-top: 1rem; color: #888; font-size: 0.85rem; }
  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7); display: none;
    align-items: center; justify-content: center; z-index: 100;
  }
  #modal { background: #fff; padding: 1.5rem; border-radius: 15px; width: 92%; max-width: 400px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
  #modal-message { font-size: 1.4rem; font-weight: bold; text-align: center; margin-bottom: 0.8rem; }
  #modal-explanation {
    font-size: 0.95rem; color: #444; margin-top: 1rem;
    border-top: 1px solid #eee; padding-top: 1rem; line-height: 1.6;
  }
  #modalNextBtn {
    display: block; width: 100%; padding: 1rem; margin-top: 1.5rem;
    border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold;
    background: #3498db; color: #fff; cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">
  <h1 id="mainTitle">È´òÊ†°ÁîüÁî®SPIÂØæÁ≠ñ</h1>
  <div id="category-select">
    <button class="tag-btn btn-verbal" onclick="startQuiz('verbal')">Ë®ÄË™ûÂàÜÈáé</button>
    <button class="tag-btn btn-nonverbal" onclick="startQuiz('nonverbal')">ÈùûË®ÄË™ûÂàÜÈáé</button>
  </div>
  <div id="quiz" style="display:none;">
    <div id="question"></div>
    <ul id="options"></ul>
    <div id="progress"></div>
  </div>
  <div id="result" style="display:none; text-align:center;">
    <div id="result-content"></div>
    <button class="tag-btn" style="background:#d4edda; border-color:#28a745;" onclick="restartWithNewQuestions()">Á∂ö„Åë„Çã</button>
    <button class="tag-btn" style="background:#f1f2f6; border-color:#dcdde1;" onclick="location.reload()">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
  </div>
</div>
<div id="overlay">
  <div id="modal">
    <div id="modal-message"></div>
    <div id="modal-explanation"></div>
    <button id="modalNextBtn">Ê¨°„Å∏ ‚ñ∂</button>
  </div>
</div>
<script>
  let allQuestions = []; 
  let questions = [];    
  let current = 0, score = 0, currentFileName = '';
  async function startQuiz(tag) {
    document.getElementById('category-select').style.display = 'none';
    document.getElementById('mainTitle').style.display = 'none'; 
    currentFileName = `${tag}.csv`;
    try {
      allQuestions = await loadCSV(currentFileName);
    } catch(err) {
      alert("Ë™≠„ÅøËæº„ÅøÂ§±Êïó");
      location.reload();
      return;
    }
    restartWithNewQuestions();
  }
  function getClearedIds() {
    const data = localStorage.getItem('cleared_' + currentFileName);
    return data ? JSON.parse(data) : [];
  }
  function saveClearedId(id) {
    let cleared = getClearedIds();
    if (!cleared.includes(id)) {
      cleared.push(id);
      localStorage.setItem('cleared_' + currentFileName, JSON.stringify(cleared));
    }
  }
  function restartWithNewQuestions() {
    document.getElementById('result').style.display = 'none';
    const clearedIds = getClearedIds();
    const unsolved = allQuestions.filter(q => !clearedIds.includes(q.id));
    const solved = allQuestions.filter(q => clearedIds.includes(q.id));
    let selection = shuffle([...unsolved]);
    if (selection.length < 10) {
      const needed = 10 - selection.length;
      selection = selection.concat(shuffle([...solved]).slice(0, needed));
    } else {
      selection = selection.slice(0, 10);
    }
    questions = selection;
    current = 0; score = 0;
    document.getElementById('quiz').style.display = 'block';
    showQuestion();
  }
  async function loadCSV(file) {
    const response = await fetch(file);
    const text = await response.text();
    const parseCsvLine = (line) => {
      let result = [];
      let currentField = '', inQuote = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuote && line[i + 1] === '"') {
            currentField += '"'; i++;
          } else {
            inQuote = !inQuote;
          }
        } else if (char === ',' && !inQuote) {
          result.push(currentField);
          currentField = '';
        } else {
          currentField += char;
        }
      }
      result.push(currentField);
      return result.map(f => f.trim());
    };
    return text.trim().split(/\r?\n/).slice(1).map(line => {
      if (!line.trim()) return null;
      const c = parseCsvLine(line);
      if (c.length < 5) return null;
      const id = c[0];
      const qText = c[1].replace(/\\n/g, '\n');
      const imgFile = c[2];
      const answerNum = parseInt(c[c.length - 2]);
      const explanationTxt = c[c.length - 1].replace(/\\n/g, '\n');
      const opts = c.slice(3, c.length - 2).filter(opt => opt !== "");
      return { id: id, q: qText, img: imgFile, options: opts, answer: answerNum - 1, explanation: explanationTxt };
    }).filter(q => q !== null);
  }
  function shuffle(a) {
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function showQuestion() {
    const q = questions[current];
    let qHtml = '';
    const partsTable = q.q.split(' / ');
    if (partsTable.length > 1 && partsTable[0].includes('=')) {
      let tableHtml = '<table class="sub-table"><tr>';
      const mappings = partsTable[0].split(' ');
      mappings.forEach(m => {
        const pair = m.split('=');
        if (pair[0]) tableHtml += `<th>${pair[0]}</th>`;
      });
      tableHtml += '</tr><tr>';
      mappings.forEach(m => {
        const pair = m.split('=');
        if (pair[1]) tableHtml += `<td>${pair[1]}</td>`;
      });
      tableHtml += '</tr></table>';
      qHtml = tableHtml + `<div style="text-align:center; font-size:1.4rem; margin:1rem 0;">${partsTable[1].replace(/\n/g, '<br>')}</div>`;
    } else if (q.id.startsWith('V') && q.q.includes('\n')) {
      const lines = q.q.split('\n');
      if (lines.length === 2) {
        qHtml = `<div style="display:flex; justify-content:center; gap:2rem; font-size:1.4rem; margin:2rem 0; font-weight:bold; letter-spacing:0.1rem; font-family:monospace;"><span>${lines[0]}</span><span>${lines[1]}</span></div>`;
      } else {
        qHtml = `<div>${q.q.replace(/\n/g, '<br>')}</div>`;
      }
    } else {
      qHtml = `<div>${q.q.replace(/\n/g, '<br>')}</div>`;
    }
    if (q.img && q.img.startsWith('[TABLE]')) {
      const rows = q.img.replace('[TABLE]', '').split(';');
      let customTable = '<table class="sub-table">';
      rows.forEach((row, i) => {
        customTable += '<tr>';
        const cells = row.split(',');
        cells.forEach(cell => {
          const content = cell.replace(/\\n/g, '<br>');
          customTable += i === 0 ? `<th>${content}</th>` : `<td>${content}</td>`;
        });
        customTable += '</tr>';
      });
      customTable += '</table>';
      qHtml += customTable;
    } else if (q.img && q.img.trim() !== "") {
      qHtml += `<img src="images/${q.img}" class="q-img">`;
    }
    document.getElementById('question').innerHTML = qHtml;
    const ul = document.getElementById('options');
    ul.innerHTML = '';
    q.options.forEach((opt, i) => {
      const li = document.createElement('li');
      li.innerHTML = `<button><span>${opt}</span></button>`;
      li.firstChild.onclick = () => selectAnswer(i);
      ul.appendChild(li);
    });
    document.getElementById('progress').textContent = `${current + 1} / ${questions.length}`;
  }
  function selectAnswer(idx) {
    const q = questions[current];
    const btns = document.getElementById('options').querySelectorAll('button');
    btns.forEach((btn, i) => {
      btn.disabled = true;
      if (i === q.answer) btn.style.background = '#d4edda';
      else if (i === idx) btn.style.background = '#f8d7da';
    });
    const isCorrect = (idx === q.answer);
    if (isCorrect) {
      score++;
      saveClearedId(q.id);
    }
    document.getElementById('modal-message').innerHTML = isCorrect ? 'üü¢ Ê≠£Ëß£' : '‚ùå ‰∏çÊ≠£Ëß£';
    document.getElementById('modal-explanation').innerHTML = "Ê≠£Ëß£Ôºö<strong>" + q.options[q.answer] + "</strong><br><br><strong>Ëß£Ë™¨:</strong><br>" + q.explanation;
    document.getElementById('overlay').style.display = 'flex';
  }
  document.getElementById('modalNextBtn').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    if (++current < questions.length) showQuestion();
    else showResults();
  };
  function showResults() {
    document.getElementById('quiz').style.display = 'none';
    const r = document.getElementById('result');
    document.getElementById('result-content').innerHTML = `<h2>ÁµêÊûú</h2><div style="font-size:2.5rem; font-weight:bold;">${score} / ${questions.length}</div>`;
    r.style.display = 'block';
  }
</script>
</body>
</html>
